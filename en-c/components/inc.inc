<?php

# jalal7h@gmail.com
# 2017/01/10
# 5.5





###########################################################################################
#
# config
if(! file_exists("config.php") ){
	echo "no config.php found";
	die();
} else {
	include_once 'config.php';
}
#
###########################################################################################





###########################################################################################
#
# license management

#
# variables
$sn = strtolower( $_SERVER['SERVER_NAME'] );
$sn = str_replace("www.", "", $sn);

#
# its local
if( in_array( substr($sn,0,8) , array("127.0.0." , "192.168.") ) ){
	$valid_license = true;

#
# check for product keys
} else if( defined('__product_key') and (__product_key != '') ){
	foreach( explode(',',__product_key) as $i => $pk ){
		if( substr(md5(md5($sn)."@parsunix"),7,18) == $pk ){
			$valid_license = true;
			break;
		}
	}
}

if( $valid_license !== true ) {
	echo "<br /><b>Parse error</b>:  syntax error, unexpected '!' in <b>".dirname(dirname(__FILE__))."/index.php</b> on line <b>0</b><br />";
    die();
}
#
###########################################################################################





###########################################################################################
# set defines  { _DOMAIN , _URL , _URI , _DIR , do_action }

#
# _DOMAIN # parsunux.com
define( '_DOMAIN' , str_replace('www.', '', $_SERVER['HTTP_HOST']) );

#
# _URL
$URLFOTDEFINE = "http://".str_replace("/","",$_SERVER['HTTP_HOST']);
$SUBFOLDER = substr( dirname($_SERVER['SCRIPT_NAME']),1,strlen(dirname($_SERVER['SCRIPT_NAME'])) );
if(strlen($SUBFOLDER)!=0) $URLFOTDEFINE .= "/".$SUBFOLDER;
define('_URL',$URLFOTDEFINE); # http://parsunix.com/demo

# 
# _URI
$_URI = $_SERVER['REQUEST_URI'];
if( dirname($_SERVER['SCRIPT_NAME']) != '/' ){
	$_URI = str_replace( dirname($_SERVER['SCRIPT_NAME']), '', $_URI );
}
define( '_URI', $_URI ); # /index.php?page=admin

#
# full path visible in browser url
define( '_FULL_URL', _URL._URI );

#
# do action
define( 'do_action', trim($_REQUEST['do_action']) );

# 
###########################################################################################





###########################################################################################
# 
# component include and sync

#
# checkif its encoded
if( file_exists("components/.codec") ){
	define( 'its_encoded', true );
} else {
	define( 'its_encoded', false );
}

#
# dropbox dir
if(@ file_exists('/Users/jalal/Dropbox/scripts/php/content_machine') ){
	define('dropbox_dir','/Users/jalal/Dropbox/scripts/php/content_machine');
}

#
# check if its localhost or not
if( its_encoded === true ){
	define( 'its_a_developer', false );
} else if( defined('dropbox_dir') and file_exists('allow.inc') and !$_REQUEST['do_action'] ){
	define( 'its_a_developer', true );
} else {
	define( 'its_a_developer', false );
}

#
# sync inc and index
if( its_a_developer === true ){
	
	#
	# inc
	$dropbox_path = dropbox_dir.'/components/inc.inc';
	$project_path = "components/inc.inc";
	if( md5_file($dropbox_path) == md5_file($project_path) ){
		// inc is sync
	} else {
		// inc needs to sync
		if(! copy( $dropbox_path, $project_path ) ){
			echo "could not update $project_path";
			die();
		} else {
			echo "inc.inc updated.<br>please reload the page.";
			die();
		}
	}

	#
	# index
	$dropbox_path = dropbox_dir.'/index.php';
	$project_path = "index.php";
	if( md5_file($dropbox_path) == md5_file($project_path) ){
		// index is sync
	} else {
		// index needs to sync
		if(! copy($dropbox_path, $project_path) ){
			echo "could not update $project_path";
			die();
		} else {
			echo "index.php updated.<br>please reload the page.";
			die();
		}
	}
}


#
# sync and include
$dir_name = "components";
if(! $dp = opendir($dir_name) ){
	die("Error in opening component directory");
} else while( $component = readdir($dp) ){
	include_component( $dir_name , $component );
}
closedir($dp);

#
# include .init.php 
if( sizeof($GLOBALS['include_all_init']) ){
	sort( $GLOBALS['include_all_init'] );
	#
	foreach( $GLOBALS['include_all_init'] as $k => $this_file ){
		// echo $this_file."<br>";
		include_once( $this_file );
	}
}


#
# include codec
if( its_encoded === true ){
	
	$codec_path = "components/.codec";
	if(! $inc_all = file_get_contents( $codec_path ) ){
		echo "cant read the codec file\n";
		die();

	} else {
		$inc_all = explode("\n\n", $inc_all);
		$inc_all = $inc_all[1];
		$inc_all = cmdeco( $inc_all );
		eval( $inc_all );
	}

}

#
# include .php
if( sizeof($GLOBALS['include_all_php']) ){
	sort( $GLOBALS['include_all_php'] );
	#
	foreach( $GLOBALS['include_all_php'] as $k => $this_file ){
		include_once( $this_file );
	}
}
#
###########################################################################################





###########################################################################################
#
# THEME
define( '_THEME', (setting('template') ?setting('template') :"Default") );
#
###########################################################################################










###########################################################################################
#
# template includes
#
# template .php include
$theme_dir = "templates/"._THEME."/php";
if( file_exists($theme_dir) ){

	$files_to_include = null;

	if(!$dp = opendir($theme_dir)){
		echo "could not open the directory '".$theme_dir."'";

	} else while($file = readdir($dp)){
		if(substr($file,0,1) == "."){
			continue;
		} else {
			$files_to_include[] = $theme_dir."/".$file;
		}
	}

	closedir($dp);

	if(sizeof($files_to_include)){
		sort($files_to_include);
		foreach($files_to_include as $k => $file_to_include){
			include_once($file_to_include);
		}
	}

}
#
# template .template include
$theme_dir = "templates/"._THEME."/template";
if( file_exists($theme_dir) ){

	$files_to_include = null;

	if(!$dp = opendir($theme_dir)){
		echo "could not open the directory '".$theme_dir."'";

	} else while($file = readdir($dp)){

		if(substr($file,0,1) == "."){
			continue;

		} else {
			$GLOBALS['include_all_template'][ substr($file,0,-13) ] = $theme_dir."/".$file;
		}

	}
	closedir($dp);

}


#
# template .js include
$theme_dir = "templates/"._THEME."/js";
if( file_exists($theme_dir) ){
	$files_to_include = null;

	if(!$dp = opendir($theme_dir)){
		echo "could not open the directory '".$theme_dir."'";

	} else while($file = readdir($dp)){

		if(substr($file,0,1) == "."){
			continue;

		} else {
			$GLOBALS['include_all_js'][$file] = $theme_dir."/".$file;
		}

	}
	closedir($dp);

}
#
# template images include
$theme_dir = "templates/"._THEME."/images";
if( file_exists($theme_dir) ){

	$files_to_include = null;

	if(!$dp = opendir($theme_dir)){
		echo "could not open the directory '".$theme_dir."'";

	} else while($file = readdir($dp)){
		if(substr($file,0,1) == "."){
			continue;
		} else {
			$GLOBALS['include_all_image'][$file] = $theme_dir."/".$file;
		}
	}
	
	closedir($dp);

}
#
###########################################################################################




do_init();




###########################################################################################
#
function cmdeco( $code ){
	
	$code = base64_decode($code);
	$code = strrev($code);
	$pk = __product_key;
	
	for($j=0; $j<strlen($pk); $j++){
	
		if( $key_done[$pk[$j]] ){
			continue;
	
		} else {
			$key_done[$pk[$j]] = true;
			$pk_clean.= $pk[$j];
		}
	
	}
	
	$pk = $pk_clean;
	$pk = strrev($pk);
	
	for( $i=0; $i<strlen($pk); $i++ ){
		$pkc = $pk[$i];
		$pkc_old = ":".chr( ord($pkc) + 7 ).";";
		$code = str_replace( $pkc_old , $pkc , $code );
	}

	for($k=9; $k>=0; $k--){
		$code = str_replace( chr(255-ord($k)) , $k , $code );		
	}

	foreach (range('Z', 'A') as $k){
		$code = str_replace( chr(255-ord($k)) , $k , $code );		
	}

	foreach (range('z', 'a') as $k){
		$code = str_replace( chr(255-ord($k)) , $k , $code );		
	}

	$code = base64_decode($code);
	return $code;

}
#
###########################################################################################





###########################################################################################
#
// function delay_diff( $line ){
// 	if( $_REQUEST['do_action'] == 'useronline_console' ){
// 		return false;
// 	}
// 	list($usec, $sec) = explode(" ", microtime());
// 	$q = ((float)$usec + (float)$sec);

// 	$q = intval(round($q * 1000));

// 	$diff = $GLOBALS[ __FUNCTION__ ] ? ($q - $GLOBALS[ __FUNCTION__ ]) : 0;
// 	$GLOBALS[ __FUNCTION__ ] = $q;
// 	if( $diff == 0 ){
// 		error_log( 'delay_diff - - - - - - - - - - - - - - - - - - - - - - ' );
// 	}
// 	error_log( 'delay_diff - '.$line.' - '.$diff.'ms ; '.$_REQUEST['page']." / ".$_REQUEST['do_action'] .(($diff > 500) ? ' - * * * * * * * * *' : '' ) );
// }
// delay_diff( __LINE__ );
#
###########################################################################################



function include_component( $dir_name , $component ){

	if(! is_dir( $dir_name."/".$component) ){
		// it its not a directory
		return false;
	
	} else if( substr($component,0,1) == '.' ){
		// its disabled
		return false;
	
	} else if(! $dp0 = opendir($dir_name."/".$component) ){
		die("Error in opening directory");
	
	} else while( $file = readdir($dp0) ){
		
		if( substr($file,0,1) == '.' ){
			continue;

		} else {
			
			#
			# sync (name of directory is effective, but the name of file is not)
			if( its_a_developer and file_exists(dropbox_dir.'/components/'.$component) ){

				$dropbox_path = dropbox_dir.'/components/'.$component.'/'.$file;
				$project_path = $dir_name."/".$component.'/'.$file;
				
				#
				# sync current files
				if(@ md5_file($dropbox_path) == @md5_file($project_path) ){ // sync check
					// its sync

				} else if( strstr(implode('',file($project_path)),'-spi-') ){ // no need to sync check
					// no need to sync check

				} else if(!file_exists($dropbox_path)){
					// file is deprecated, you need to remove it
					rename($project_path, dirname($project_path)."/".date(".dMY-").basename($project_path));
					continue; // also no need to include it

				} else {
					// needs to sync
					if(! copy($dropbox_path, $project_path) ){
						echo "could not update $project_path";
						die();

					} else {
						// sync was needed, and its sync now
					}

				}
				
				#
				# coping new files to project
				if(! $dp1 = opendir(dropbox_dir.'/components/'.$component) ){
					echo "err - ".__LINE__;

				} else while( $d1 = readdir($dp1) ){
					
					$dropb_file = dropbox_dir.'/components/'.$component."/".$d1;
					$local_file = $dir_name."/".$component.'/'.$d1;
					
					if( is_dir($dropb_file) ){
						// directories in components will be viawed
						continue;
					
					} else if( file_exists($local_file) ){
						// it exists, its not a new file
					
					} else if(! copy($dropb_file , $local_file) ){
						echo "could not copy $local_file";
						die();
					}

				}
			}
			
			#
			# include
			if( substr($file,0,1) == '.' ){
				continue;
			
			} else if(in_array(strtolower(strrchr($file,".")),array(".jpg",".jpeg",".png",".gif"))){
				$GLOBALS['include_all_image'][$file] = $dir_name."/".$component."/".$file;
			
			} else if( in_array( substr($file,-13) , ['.template.php','.template.htm'] ) ){
				$GLOBALS['include_all_template'][ substr($file,0,-13) ] = $dir_name."/".$component."/".$file;
			
			} else if(strrchr($file,'.') == '.css'){
				$GLOBALS['include_all_css'][] = $dir_name."/".$component."/".$file;
			
			} else if(strrchr($file,'.') == '.js'){
				$GLOBALS['include_all_js'][] = $dir_name."/".$component."/".$file;
			
			} else if(strrchr($file,'.') == '.sql'){
				$GLOBALS['include_all_sql'][] = $dir_name."/".$component."/".$file;
			
			} else if($file == 'htaccess.txt'){
				$GLOBALS['include_all_htaccess'][] = $dir_name."/".$component."/".$file;
			
			} else if( substr( $file , -9 ) == '.init.php' ){
				$GLOBALS['include_all_init'][] = $dir_name."/".$component."/".$file;
			
			} else if( strrchr($file,'.') != '.php' ){
				continue;
			
			} else {
				$GLOBALS['include_all_php'][] = $dir_name."/".$component."/".$file;
			}

		}
	}

	closedir($dp0);

}



function پارسیونیکس2016(){echo "something";}